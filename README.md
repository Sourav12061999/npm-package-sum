## This is a very complicated function
